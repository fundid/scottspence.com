name: 'Rerun Failed Job'
on:
  workflow_run:
    workflows: ['Tests: E2E', 'Check: Spelling', 'Tests: Unit']
    types:
      - completed

jobs:
  rerun-failed-job:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt-get update
          sudo apt-get install gh

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Rerun failed job
        run: |
          failed_job_name=$(echo '${{ toJson(github.event.workflow_run.jobs) }}' | jq -r 'map(select(.conclusion == "failure"))[0].name')
          echo "Rerunning failed job: $failed_job_name"
          gh run rerun -R ${{ github.repository }} -w ${{ github.event.workflow_run.workflow_id }} --job $failed_job_name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
